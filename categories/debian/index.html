<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>debian | linuxabc</title>
  <meta name="author" content="alfie chan">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="linuxabc"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="linuxabc" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">linuxabc</a></h1>
  <h2><a href="/">focus on security, network management and embeded OS</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title category">debian</h2>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-06-09T03:30:00.000Z"><a href="/2012/06/09/how-to-setup-rancid-on-debian/">2012-06-9</a></time>
      
      
  
    <h1 class="title"><a href="/2012/06/09/how-to-setup-rancid-on-debian/">网络设备管理 - rancid</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Rancid的全称是Really Awesome New Cisco ConfIg Differ，顾名思义，该软件的初衷是为了管理cisco设备，然而由于它非常实用，目前已经被扩展到支持多达xx种网络设备，诸如常见的dell，hp，juniper,foundry,redback等，当然，国内常见的h3c也不在话下。<br>It‘s not that the name is not being recognized, it’s that the scripts it&#39;s running have errors in the first line which produce &quot;</p>
<p>“No such file or directory”<br>Lookup list of groups</p>
<p>For each device in each list of groups<br>• Connect to the equipment (telnet, ssh, …)<br>• Run ”show” commands – config, inventory, …<br>• Collect, filter/format data<br>• Retrieve the resulting config files<br>• CVS check-in the changes<br>• Generate a diff from the previous version<br>• E-mail the diff to a mail address (individual or group)</p>
<h1>rancid</h1>
<p>rancid的工作原理</p>
<h2>安装</h2>
<pre><code><span class="preprocessor"># aptitude install rancid-core rancid rancid-utils</span></code></pre>
<h2>Rancid配置</h2>
<p>/etc/rancid/rancid.conf</p>
<figure class="highlight"><pre><span class="setting">CVSROOT=<span class="value">$BASEDIR/SVN; export CVSROOT</span></span>
<span class="setting">RCSSYS=<span class="value">svn; export RCSSYS</span></span>
<span class="setting">LIST_OF_GROUPS=<span class="value">”access dist core”</span></span>
</pre></figure>

<ol>
<li>rancid支持CVS和SVN这两种版本管理工具，本文选择了SVN，因为CVS太古老了。</li>
<li>根据cisco的定义，一个大型的网络规划应该分成三层，分别是access、distribution和core，因此我们也创建三个组：access、dist、core</li>
</ol>
<p>配置设备</p>
<p>cd /var/lib/rancid/<br>mkdir access<br>mkdir dist<br>mkdir core<br>touch access/router.db<br>touch dist/router.db<br>touch core/router.db</p>
<p>接着往router.db里面填内容：</p>
<figure class="highlight"><pre><span class="comment"># vim access/router.db</span>
<span class="number">10.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:h3c</span><span class="symbol">:up</span><span class="symbol">:sw_access_1f_A</span>
<span class="number">10.0</span>.<span class="number">0</span>.<span class="number">2</span><span class="symbol">:h3c</span><span class="symbol">:up</span><span class="symbol">:sw_access_1f_B</span>
<span class="number">10.0</span>.<span class="number">0</span>.<span class="number">3</span><span class="symbol">:h3c</span><span class="symbol">:up</span><span class="symbol">:sw_access_1f_C</span>
<span class="number">10.0</span>.<span class="number">0</span>.<span class="number">4</span><span class="symbol">:h3c</span><span class="symbol">:up</span><span class="symbol">:sw_access_1f_D</span>
...
</pre></figure>

<p>依次创建dist/router.db和core/router.db</p>
<figure class="highlight"><pre># vim .cloginrc
add user * <span class="xml"><span class="tag">&lt;<span class="title">username</span>&gt;</span>
add password * <span class="tag">&lt;<span class="title">password</span>&gt;</span>
add method * telnet</span>
</pre></figure>

<h2>H3C脚本</h2>
<p>H3C并不在rancid的官方支持之列，不过好在有热心的网友Jethro Binks制作了<a href="http://sites.google.com/site/jrbinks/code/rancid/h3c" target="_blank">h3c的脚本</a></p>
<p>H3C的OS叫Comware，有3和5这两个系列，常见的S3100，S3600，S5600，S5800等均能正常使用。以下是经过测试的型号列表：</p>
<ol>
<li>H3C S3100 (Comware 3)</li>
<li>H3C S5600 (Comware 3)</li>
<li>H3C S7506 (Comware 5)</li>
<li>H3C S7906E (Comware 5)</li>
<li>H3C S5820X (Comware 5)</li>
<li>H3C S5800 (Comware 5)</li>
<li>H3C S3610 (Comware 5)</li>
<li>H3C MSR30-60 (Comware 5)</li>
</ol>
<p>Jethro Binks的脚本并不适合于Debian,需要做一点小修改：</p>
<p><strong>h3clogin:</strong></p>
<p>将</p>
<pre><code><span class="shebang">#! /usr/local/bin/expect --</span></code></pre>
<p>改成</p>
<pre><code><span class="shebang">#! /usr/bin/expect --</span></code></pre>
<p><strong>h3crancid:</strong></p>
<p>将</p>
<pre><code><span class="shebang">#! /usr/bin/perl5</span></code></pre>
<p>改成</p>
<pre><code><span class="shebang">#! /usr/bin/perl</span></code></pre>
<p>接着将它们拷贝到<code>/usr/lib/rancid/bin</code>中，同时赋予<code>+x</code>的属性。</p>
<pre><code><span class="preprocessor"># cp h3clogin h3crancid /usr/lib/rancid/bin</span>
<span class="preprocessor"># chmod +x h3crancid h3clogin</span></code></pre>
<h2>H3C设备配置</h2>
<p>rancid的脚本将使用perl+expect来登录H3C设备，并执行一些display命令来获取设备信息，虽然然而所以安全性需要着重考虑，直接给完整的特权账号肯定不合适，最好创建一个单独的ranciduser，并且仅分配level1权限：</p>
<p>local-user ranciduser<br>authorization-attribute level 1</p>
<p>看到这，有些读者不禁倒吸一口凉气：糟糕，手头上管理着几十台设备，难不成我要逐台登录和创建几十个相同的帐号？别急，我们完全可以利用clogin/h3clogin来自动完成这个任务。</p>
<figure class="highlight"><pre># vim <span class="operator"><span class="keyword">create</span>.rancid.account
sys
<span class="keyword">local</span>-<span class="keyword">user</span> rancid
<span class="keyword">authorization</span>-attribute <span class="keyword">level</span> <span class="number">1</span>
quit
save
</pre></figure>

<p>h3clogin -x /path/to/commands.file <device-ip></p>
<p>最后测试一下</p>
<pre><code># sudo -u rancid -H /usr/lib/rancid/h3clogin <span class="tag">&lt;<span class="title">H3C-device-ip</span>&gt;</span> FIXME</code></pre>
<h2>配置变更</h2>
<h3>硬件配置变更</h3>
<h3>软件配置变更</h3>
<h1>版本管理工具</h1>
<p>rancid利用版本管理工具对配置变更进行管理，这是一个聪明而省力的做法，unix哲学就是帅。rancid支持CVS和SVN这两个版本管理工具，本文选择的是SVN，因为CVS太古老了。</p>
<h2>安装svn</h2>
<pre><code><span class="preprocessor"># aptitude install svn</span></code></pre>
<h2>整合svn</h2>
<p>cd /var/lib/rancid/<br>svnadmin create configs<br>svn mkdir file:///var/lib/rancid/configs/access -m “created folder”<br>svn mkdir file:///var/lib/rancid/configs/dist -m “created folder”<br>svn mkdir file:///var/lib/rancid/configs/core -m “created folder”<br>svn co file:///var/lib/rancid/configs/access ./access/<br>svn co file:///var/lib/rancid/configs/dist ./dist/<br>svn co file:///var/lib/rancid/configs/core ./core/</p>
<p>chown -R rancid:rancid /var/lib/rancid/<br>chmod 0600 /var/lib/rancid/.cloginrc</p>
<h1>sudo -u rancid -H /usr/lib/rancid/bin/rancid-run</h1>
<p>svn mkdir access/configs<br>svn mkdir dist/configs<br>svn mkdir core/configs<br>svn add access/<em><br>svn add dist/</em><br>svn add core/*<br>svn commit -m “added files” access/<br>svn commit -m “added files” dist/<br>svn commit -m “added files” core/</p>
<h1>配置变更提醒</h1>
<p>当rancid检测到变更时，<code>control_rancid</code>组件利用sendmail将变更信息通过邮件发送给管理员。对于debian来说，我们将使用默认的MTA exim4来完成这项工作。</p>
<h2>exim4的安装和配置</h2>
<p>详见《<a href="">如何利用exim4通过gmail发送邮件</a>》</p>
<h2>/etc/aliases</h2>
<figure class="highlight"><pre><span class="comment"># vim /etc/aliases</span>
<span class="keyword">...</span>
rancid-&lt;group-name&gt; : mail-address@domain.name
rancid-adimin-&lt;group-name&gt; : mail-address@domain.name
<span class="keyword">...</span>
<span class="comment"># newaliases</span>
<span class="comment"># /etc/init.d/exim4 restart</span>
</pre></figure>

<p>当配置变更时，邮件将发送给rancid-<group-name>，当有错误信息时，邮件将发送给rancid-admin-<group-name>。</p>
<p>至此完成了配置变更的邮件提醒功能。</p>
<h1>查看变更历史记录</h1>
<h2>viewvc安装</h2>
<h2>viewvc配置</h2>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-06-07T15:30:00.000Z"><a href="/2012/06/07/how-to-setup-tftpd-on-debian/">2012-06-7</a></time>
      
      
  
    <h1 class="title"><a href="/2012/06/07/how-to-setup-tftpd-on-debian/">如何在debian中安装和配置tftpd</a></h1>
  

    </header>
    <div class="entry">
      
        <p>tftp服务类似FTP服务，但它短小精干，仅适合于小文件的传输，所以大多数网络设备都选择tftp作为配置文件备份、firmware升级等操作的默认传输方式。<br>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2012/06/07/how-to-setup-tftpd-on-debian/#more" class="more-link">Read More</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-06-06T15:30:00.000Z"><a href="/2012/06/06/debian-template-on-virtualbox/">2012-06-6</a></time>
      
      
  
    <h1 class="title"><a href="/2012/06/06/debian-template-on-virtualbox/">如何在VirtualBox中安装和克隆Debian VM</a></h1>
  

    </header>
    <div class="entry">
      
        <p>上一回中讲了<a href="../how-to-install-virtualbox-on-opensuse">如何在openSUSE中安装最新版VirtualBox</a>，本回将讲如何安装和克隆Debian VM。</p>
<h1>1. 环境：</h1>
<ol>
<li>HOST  OS : openSUSE11.3</li>
<li>Guest OS : Debian 6.0.5 netinstall</li>
<li>VirtualBox : 4.1.16</li>
</ol>

      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2012/06/06/debian-template-on-virtualbox/#more" class="more-link">Read More</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-04-30T15:00:00.000Z"><a href="/2012/04/30/what-can-we-deal-with-little-vps/">2012-04-30</a></time>
      
      
  
    <h1 class="title"><a href="/2012/04/30/what-can-we-deal-with-little-vps/">在debian中安装octopress</a></h1>
  

    </header>
    <div class="entry">
      
        <p>前面讲了<a href="">如何在heroku中部署octopress</a>，不过heroku毕竟不在自己的手上，对于用户来说是一个遗憾，贝多芬说了：要扼住命运的咽喉。因此自己的博客就要部署在自己的VPS上。下面讲一下如何在debian squeeze中部署git+ruby+nginx+octopress。</p>
<h1>git</h1>
<p>git的安装很简单：</p>
<figure class="highlight"><pre><span class="preprocessor"># apt-get update</span>
<span class="preprocessor"># apt-get install git-core</span>
<span class="preprocessor"># git config --global user.name "alfie chan"</span>
<span class="preprocessor"># git config --global user.email admin@linuxabc.net.cn</span>
</pre></figure>

<h1>ruby</h1>
<p>ruby的版本众多，安装和管理比较复杂。另外，<a href="http://www.lucas-nussbaum.net/blog/?p=617" target="_blank">debian开发者对ruby的代码树管理很不满</a>，<br>已经决定终止对ruby进行打包，这使得ruby在debian上的安装更为麻烦，目前squeeze中ruby的版本是1.9.1（用户通过<code>apt-cache search</code>会看到一个ruby 1.9.2，但那是虚拟包，不是真正的1.9.2），然而ocotpress对ruby的版本要求是1.9.2，因此我先是采用rvm，但是遇到一些问题，最后决定手工编译的方式进行安装。</p>
<figure class="highlight"><pre># bash &lt; &lt;( curl http://rvm.beginrescueend.com/releases/rvm-install-head )
...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 D<span class="operator"><span class="keyword">load</span>  Upload   Total   Spent    <span class="keyword">Left</span>  Speed
<span class="number">100</span>  <span class="number">994</span>k  <span class="number">100</span>  <span class="number">994</span>k    <span class="number">0</span>     <span class="number">0</span>  <span class="number">45792</span>      <span class="number">0</span>  <span class="number">0</span>:<span class="number">00</span>:<span class="number">22</span>  <span class="number">0</span>:<span class="number">00</span>:<span class="number">22</span> --:--:-- <span class="number">41842</span>

Installing RVM <span class="keyword">to</span> /usr/<span class="keyword">local</span>/rvm/
    Creating RVM system <span class="keyword">user</span> <span class="keyword">group</span> <span class="string">'rvm'</span>

# RVM:  Shell scripts enabling management <span class="keyword">of</span> multiple ruby environments.
# RTFM: https://rvm.io/
# HELP: http://webchat.freenode.net/?channels=rvm (#rvm <span class="keyword">on</span> irc.freenode.net)
# Cheatsheet: http://cheat.errtheblog.com/s/rvm/
# Screencast: http://screencasts.org/episodes/how-<span class="keyword">to</span>-use-rvm

# <span class="keyword">In</span> <span class="keyword">case</span> <span class="keyword">of</span> <span class="keyword">any</span> issues <span class="keyword">read</span> <span class="keyword">output</span> <span class="keyword">of</span> <span class="string">'rvm requirements'</span> <span class="keyword">and</span>/<span class="keyword">or</span> <span class="string">'rvm notes'</span>

Installation <span class="keyword">of</span> RVM <span class="keyword">in</span> /usr/<span class="keyword">local</span>/rvm/ <span class="keyword">is</span> almost complete:

  * <span class="keyword">First</span> you need <span class="keyword">to</span> <span class="keyword">add</span> <span class="keyword">all</span> users that will be <span class="keyword">using</span> rvm <span class="keyword">to</span> <span class="string">'rvm'</span> <span class="keyword">group</span>,
    <span class="keyword">and</span> logout - login again, anyone <span class="keyword">using</span> rvm will be operating <span class="keyword">with</span> <span class="string">`umask g+w`</span>.

  * <span class="keyword">To</span> <span class="keyword">start</span> <span class="keyword">using</span> RVM you need <span class="keyword">to</span> run <span class="string">`source /etc/profile.d/rvm.sh`</span>
    <span class="keyword">in</span> <span class="keyword">all</span> your <span class="keyword">open</span> shell windows, <span class="keyword">in</span> rare cases you need <span class="keyword">to</span> reopen <span class="keyword">all</span> shell windows.

# root,
#
#   Thank you <span class="keyword">for</span> <span class="keyword">using</span> RVM!
#   I sincerely hope that RVM helps <span class="keyword">to</span> make your life easier <span class="keyword">and</span> more enjoyable!!!
#
# ~Wayne


rvm <span class="number">1.13</span><span class="number">.0</span> (stable) <span class="keyword">by</span> Wayne E. Seguin &lt;wayneeseguin@gmail.com&gt;, Michal Papis &lt;mpapis@gmail.com&gt; [h
ttps://rvm.io/]
</pre></figure>

<p>根据上面的提示，执行：</p>
<pre><code><span class="preprocessor"># source /etc/profile.d/rvm.sh</span></code></pre>
<p>然后：</p>
<pre><code><span class="preprocessor"># rvm install 1.9.2</span></code></pre>
<p>出现错误，根据<code>/usr/local/rvm/1.9.2/extract.log</code>的错误提示，原来安装的过程中还需要用到<code>make</code>和<code>bzip2</code>这两个工具。</p>
<p>于是：</p>
<pre><code><span class="preprocessor"># aptitude install make bzip2</span></code></pre>
<p>接着：</p>
<figure class="highlight"><pre><span class="comment"># rvm install 1.9.2</span>
Fetching yaml-<span class="number">0.1</span><span class="number">.4</span>.tar.gz to /usr/local/rvm/archives
Extracting yaml-<span class="number">0.1</span><span class="number">.4</span>.tar.gz to /usr/local/rvm/src
Configuring yaml <span class="keyword">in</span> /usr/local/rvm/src/yaml-<span class="number">0.1</span><span class="number">.4</span>.
Compiling yaml <span class="keyword">in</span> /usr/local/rvm/src/yaml-<span class="number">0.1</span><span class="number">.4</span>.
Installing yaml to /usr/local/rvm/usr
Installing Ruby from <span class="keyword">source</span> to: /usr/local/rvm/rubies/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320, this may take a <span class="keyword">while</span> depend
ing on your cpu(s)<span class="keyword">...</span>

ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#fetching</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#extracting ruby-1.9.2-p320 to /usr/local/rvm/src/ruby-1.9.2-p320</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#extracted to /usr/local/rvm/src/ruby-1.9.2-p320</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#configuring</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#compiling</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#installing</span>
Retrieving rubygems-<span class="number">1.8</span><span class="number">.24</span>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span class="number">100</span>  371k  <span class="number">100</span>  371k    <span class="number">0</span>     <span class="number">0</span>  <span class="number">35412</span>      <span class="number">0</span>  <span class="number">0</span>:<span class="number">00</span>:<span class="number">10</span>  <span class="number">0</span>:<span class="number">00</span>:<span class="number">10</span> --:--:-- <span class="number">51058</span>
Extracting rubygems-<span class="number">1.8</span><span class="number">.24</span> <span class="keyword">...</span>
Removing old Rubygems files...
Installing rubygems-<span class="number">1.8</span><span class="number">.24</span> <span class="keyword">for</span> ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 <span class="keyword">...</span>
Installation of rubygems completed successfully.
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - adjusting <span class="comment">#shebangs for (gem irb erb ri rdoc testrb rake).</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#importing default gemsets (/usr/local/rvm/gemsets/)</span>
Install of ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#complete</span>
</pre></figure>

<p>然后通过git将octopress克隆到本地：</p>
<figure class="highlight"><pre><span class="comment"># git clone git://github.com/imathis/octopress.git octopress</span>
<span class="comment"># cd octopress</span>
====================================================================================
= NOTICE                                                                           =
====================================================================================
= RVM has encountered a new <span class="keyword">or</span> modified .rvmrc <span class="type">file</span> <span class="keyword">in</span> <span class="keyword">the</span> current directory       =
= This <span class="keyword">is</span> a shell <span class="keyword">script</span> <span class="keyword">and</span> therefore may <span class="keyword">contain</span> any shell commands.             =
=                                                                                  =
= Examine <span class="keyword">the</span> <span class="property">contents</span> <span class="keyword">of</span> this <span class="type">file</span> carefully <span class="keyword">to</span> be sure <span class="keyword">the</span> <span class="property">contents</span> are          =
= safe <span class="keyword">before</span> trusting <span class="keyword">it</span>! ( Choose v[iew] <span class="keyword">below</span> <span class="keyword">to</span> view <span class="keyword">the</span> <span class="property">contents</span> )            =
====================================================================================
Do you wish <span class="keyword">to</span> trust this .rvmrc <span class="type">file</span>? (/home/chenr/octopress/.rvmrc)
y[es], n[o], v[iew], c[ancel]&gt; y
Using /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320
</pre></figure>

<figure class="highlight"><pre><span class="comment"># rake install</span>
rake aborted!
You have already activated rake <span class="number">0.9</span><span class="number">.2</span><span class="number">.2</span>, <span class="keyword">but</span> your Gemfile requires rake <span class="number">0.9</span><span class="number">.2</span>. Using bundle exec may solve this.

(See full trace <span class="keyword">by</span> <span class="property">running</span> task <span class="keyword">with</span> <span class="comment">--trace)</span>
</pre></figure>

<p>也就是说要用bundle exec rake</p>
<figure class="highlight"><pre>root<span class="property">@deb600</span>-<span class="number">64</span>-mgmt:<span class="regexp">/home/chenr/</span>octopress<span class="comment"># bundle exec rake install</span>
<span class="comment">## Copying classic theme into ./source and ./sass</span>
root<span class="property">@deb600</span>-<span class="number">64</span>-mgmt:<span class="regexp">/home/chenr/</span>octopress<span class="comment">#</span>
</pre></figure>

<p>创建第一篇博客</p>
<figure class="highlight"><pre><span class="preprocessor"># bundle exec rake new_post["hello-octopress"]</span>
<span class="preprocessor"># vim ./source/_post/2012-04-30-hello-octopress.markdown</span>
</pre></figure>

<p>生成静态网站</p>
<figure class="highlight"><pre>deb600-<span class="number">64</span>-mgmt:/home/chenr/octopress/source/_posts<span class="comment"># bundle exec rake generat</span>
(<span class="keyword">in</span> /home/chenr/octopress)
<span class="comment">## Generating Site with Jekyll</span>
unchanged sass/screen.scss
Configuration <span class="keyword">from</span> /home/chenr/octopress/_config.yml
/usr/<span class="keyword">local</span>/rvm/rubies/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/lib/ruby/<span class="number">1.9</span><span class="number">.1</span>/net/https.rb:<span class="number">92</span>:<span class="keyword">in</span> `require': no such <span class="type">file</span> <span class="keyword">to</span> load <span class="comment">-- openssl (LoadError)</span>
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/rubies/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/lib/ruby/<span class="number">1.9</span><span class="number">.1</span>/net/https.rb:<span class="number">92</span>:<span class="keyword">in</span> `&lt;top (required)&gt;'
        <span class="keyword">from</span> /home/chenr/octopress/plugins/gist_tag.rb:<span class="number">10</span>:<span class="keyword">in</span> `require'
        <span class="keyword">from</span> /home/chenr/octopress/plugins/gist_tag.rb:<span class="number">10</span>:<span class="keyword">in</span> `&lt;top (required)&gt;'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/lib/jekyll/site.rb:<span class="number">76</span>:<span class="keyword">in</span> `require'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/lib/jekyll/site.rb:<span class="number">76</span>:<span class="keyword">in</span> `block <span class="keyword">in</span> setup'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/lib/jekyll/site.rb:<span class="number">75</span>:<span class="keyword">in</span> `each'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/lib/jekyll/site.rb:<span class="number">75</span>:<span class="keyword">in</span> `setup'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/lib/jekyll/site.rb:<span class="number">30</span>:<span class="keyword">in</span> `initialize'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/bin/jekyll:<span class="number">224</span>:<span class="keyword">in</span> `new'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/bin/jekyll:<span class="number">224</span>:<span class="keyword">in</span> `&lt;top (required)&gt;'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/bin/jekyll:<span class="number">23</span>:<span class="keyword">in</span> `load'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/bin/jekyll:<span class="number">23</span>:<span class="keyword">in</span> `&lt;main&gt;'
</pre></figure>

<p>google<br><code>/usr/local/rvm/rubies/ruby-1.9.2-p320/lib/ruby/1.9.1/net/https.rb:92:in</code>require&#39;: no such file to load — openssl (LoadError)`</p>
<p>依稀记得octopress推荐使用ruby-1.9.2-p290，于是</p>
<figure class="highlight"><pre><span class="preprocessor"># rvm install ruby-1.9.2-p290</span>
<span class="preprocessor"># rvm use ruby-1.9.2-p290</span>
<span class="preprocessor"># bundle exec rake generate</span>
</pre></figure>

<p>错误依旧，傻眼了，还得求助google，我换了一下关键字<code>require&#39;: no such file to load -- openssl (LoadError)</code></p>
<p>这次有结果了：<a href="http://blog.bigdinosaur.org/setting-up-octopress/" target="_blank">Setting Up Octopress</a></p>
<p>原来是还缺<code>libssl-dev</code>这个软件包</p>
<pre><code><span class="preprocessor"># aptitude install libssl-dev</span>
<span class="preprocessor"># rvm reinstall ruby-1.9.2-p290</span></code></pre>
<p>终于成功了！归根结底，rvm在安装ruby时，即便缺乏依赖包也没有提示，看来用rvm来安装ruby不怎么靠谱啊。即便用rbenv</p>
<h1>nginx</h1>
<h2>编译和安装</h2>
<figure class="highlight"><pre><span class="comment">#</span> <span class="string">.</span><span class="comment">/configure</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">sbin</span>-<span class="comment">path=/usr/sbin</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">conf</span>-<span class="comment">path=/etc/nginx/nginx</span>.<span class="comment">conf</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">error</span>-<span class="comment">log</span>-<span class="comment">path=/var/log/nginx/error</span>.<span class="comment">log</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">pid</span>-<span class="comment">path=/var/run/nginx</span>.<span class="comment">pid</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">lock</span>-<span class="comment">path=/var/lock/nginx</span>.<span class="comment">lock</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span>-<span class="comment">log</span>-<span class="comment">path=/var/log/nginx/access</span>.<span class="comment">log</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span>-<span class="comment">client</span>-<span class="comment">body</span>-<span class="comment">temp</span>-<span class="comment">path=/var/lib/nginx/body</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span>-<span class="comment">proxy</span>-<span class="comment">temp</span>-<span class="comment">path=/var/lib/nginx/proxy</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span>-<span class="comment">fastcgi</span>-<span class="comment">temp</span>-<span class="comment">path=/var/lib/nginx/fastcgi</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span>-<span class="comment">debug</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span>-<span class="comment">http_stub_status_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span>-<span class="comment">http_flv_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span>-<span class="comment">http_ssl_module</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span>-<span class="comment">http_dav_module</span>


<span class="comment">Configuration</span> <span class="comment">summary</span>
  <span class="literal">+</span> <span class="comment">using</span> <span class="comment">system</span> <span class="comment">PCRE</span> <span class="comment">library</span>
  <span class="literal">+</span> <span class="comment">using</span> <span class="comment">system</span> <span class="comment">OpenSSL</span> <span class="comment">library</span>
  <span class="literal">+</span> <span class="comment">md5:</span> <span class="comment">using</span> <span class="comment">OpenSSL</span> <span class="comment">library</span>
  <span class="literal">+</span> <span class="comment">sha1:</span> <span class="comment">using</span> <span class="comment">OpenSSL</span> <span class="comment">library</span>
  <span class="literal">+</span> <span class="comment">using</span> <span class="comment">system</span> <span class="comment">zlib</span> <span class="comment">library</span>

  <span class="comment">nginx</span> <span class="comment">path</span> <span class="comment">prefix:</span> <span class="comment">"/usr/local/nginx"</span>
  <span class="comment">nginx</span> <span class="comment">binary</span> <span class="comment">file:</span> <span class="comment">"/usr/sbin"</span>
  <span class="comment">nginx</span> <span class="comment">configuration</span> <span class="comment">prefix:</span> <span class="comment">"/etc/nginx"</span>
  <span class="comment">nginx</span> <span class="comment">configuration</span> <span class="comment">file:</span> <span class="comment">"/etc/nginx/nginx</span>.<span class="comment">conf"</span>
  <span class="comment">nginx</span> <span class="comment">pid</span> <span class="comment">file:</span> <span class="comment">"/var/run/nginx</span>.<span class="comment">pid"</span>
  <span class="comment">nginx</span> <span class="comment">error</span> <span class="comment">log</span> <span class="comment">file:</span> <span class="comment">"/var/log/nginx/error</span>.<span class="comment">log"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">access</span> <span class="comment">log</span> <span class="comment">file:</span> <span class="comment">"/var/log/nginx/access</span>.<span class="comment">log"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">client</span> <span class="comment">request</span> <span class="comment">body</span> <span class="comment">temporary</span> <span class="comment">files:</span> <span class="comment">"/var/lib/nginx/body"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">proxy</span> <span class="comment">temporary</span> <span class="comment">files:</span> <span class="comment">"/var/lib/nginx/proxy"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">fastcgi</span> <span class="comment">temporary</span> <span class="comment">files:</span> <span class="comment">"/var/lib/nginx/fastcgi"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">uwsgi</span> <span class="comment">temporary</span> <span class="comment">files:</span> <span class="comment">"uwsgi_temp"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">scgi</span> <span class="comment">temporary</span> <span class="comment">files:</span> <span class="comment">"scgi_temp"</span>

<span class="comment">#</span> <span class="comment">make</span> <span class="comment">&</span> <span class="comment">make</span> <span class="comment">install
</pre></figure>

<h1>mkdir /var/log/nginx &amp;&amp; chown nginx:nignix /var/log/nginx</h1>
<h1>mkdir /var/lib/nginx &amp;&amp; chown nginx:nignix /var/lib/nginx</h1>
<figure class="highlight"><pre>/etc/<span class="filename">init.d/nginx
</pre></figure>

<p>检测一下：</p>
<pre><code><span class="preprocessor"># lynx localhost</span></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-04-30T15:00:00.000Z"><a href="/2012/04/30/how-to-install-octopress-on-debian/">2012-04-30</a></time>
      
      
  
    <h1 class="title"><a href="/2012/04/30/how-to-install-octopress-on-debian/">在debian中安装octopress</a></h1>
  

    </header>
    <div class="entry">
      
        <p>前面讲了<a href="">如何在heroku中部署octopress</a>，不过heroku毕竟不在自己的手上，对于用户来说是一个遗憾，贝多芬说了：要扼住命运的咽喉。因此自己的博客就要部署在自己的VPS上。下面讲一下如何在debian squeeze中部署git+ruby+nginx+octopress。</p>
<h1>git</h1>
<p>git的安装很简单：</p>
<figure class="highlight"><pre><span class="preprocessor"># apt-get update</span>
<span class="preprocessor"># apt-get install git-core</span>
<span class="preprocessor"># git config --global user.name "alfie chan"</span>
<span class="preprocessor"># git config --global user.email admin@linuxabc.net.cn</span>
</pre></figure>

<h1>ruby</h1>
<p>ruby的版本众多，安装和管理比较复杂。另外，<a href="http://www.lucas-nussbaum.net/blog/?p=617" target="_blank">debian开发者对ruby的代码树管理很不满</a>，<br>已经决定终止对ruby进行打包，这使得ruby在debian上的安装更为麻烦，目前squeeze中ruby的版本是1.9.1（用户通过<code>apt-cache search</code>会看到一个ruby 1.9.2，但那是虚拟包，不是真正的1.9.2），然而ocotpress对ruby的版本要求是1.9.2，因此我先是采用rvm，但是遇到一些问题，最后决定手工编译的方式进行安装。</p>
<figure class="highlight"><pre># bash &lt; &lt;( curl http://rvm.beginrescueend.com/releases/rvm-install-head )
...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 D<span class="operator"><span class="keyword">load</span>  Upload   Total   Spent    <span class="keyword">Left</span>  Speed
<span class="number">100</span>  <span class="number">994</span>k  <span class="number">100</span>  <span class="number">994</span>k    <span class="number">0</span>     <span class="number">0</span>  <span class="number">45792</span>      <span class="number">0</span>  <span class="number">0</span>:<span class="number">00</span>:<span class="number">22</span>  <span class="number">0</span>:<span class="number">00</span>:<span class="number">22</span> --:--:-- <span class="number">41842</span>

Installing RVM <span class="keyword">to</span> /usr/<span class="keyword">local</span>/rvm/
    Creating RVM system <span class="keyword">user</span> <span class="keyword">group</span> <span class="string">'rvm'</span>

# RVM:  Shell scripts enabling management <span class="keyword">of</span> multiple ruby environments.
# RTFM: https://rvm.io/
# HELP: http://webchat.freenode.net/?channels=rvm (#rvm <span class="keyword">on</span> irc.freenode.net)
# Cheatsheet: http://cheat.errtheblog.com/s/rvm/
# Screencast: http://screencasts.org/episodes/how-<span class="keyword">to</span>-use-rvm

# <span class="keyword">In</span> <span class="keyword">case</span> <span class="keyword">of</span> <span class="keyword">any</span> issues <span class="keyword">read</span> <span class="keyword">output</span> <span class="keyword">of</span> <span class="string">'rvm requirements'</span> <span class="keyword">and</span>/<span class="keyword">or</span> <span class="string">'rvm notes'</span>

Installation <span class="keyword">of</span> RVM <span class="keyword">in</span> /usr/<span class="keyword">local</span>/rvm/ <span class="keyword">is</span> almost complete:

  * <span class="keyword">First</span> you need <span class="keyword">to</span> <span class="keyword">add</span> <span class="keyword">all</span> users that will be <span class="keyword">using</span> rvm <span class="keyword">to</span> <span class="string">'rvm'</span> <span class="keyword">group</span>,
    <span class="keyword">and</span> logout - login again, anyone <span class="keyword">using</span> rvm will be operating <span class="keyword">with</span> <span class="string">`umask g+w`</span>.

  * <span class="keyword">To</span> <span class="keyword">start</span> <span class="keyword">using</span> RVM you need <span class="keyword">to</span> run <span class="string">`source /etc/profile.d/rvm.sh`</span>
    <span class="keyword">in</span> <span class="keyword">all</span> your <span class="keyword">open</span> shell windows, <span class="keyword">in</span> rare cases you need <span class="keyword">to</span> reopen <span class="keyword">all</span> shell windows.

# root,
#
#   Thank you <span class="keyword">for</span> <span class="keyword">using</span> RVM!
#   I sincerely hope that RVM helps <span class="keyword">to</span> make your life easier <span class="keyword">and</span> more enjoyable!!!
#
# ~Wayne


rvm <span class="number">1.13</span><span class="number">.0</span> (stable) <span class="keyword">by</span> Wayne E. Seguin &lt;wayneeseguin@gmail.com&gt;, Michal Papis &lt;mpapis@gmail.com&gt; [h
ttps://rvm.io/]
</pre></figure>

<p>根据上面的提示，执行：</p>
<pre><code><span class="preprocessor"># source /etc/profile.d/rvm.sh</span></code></pre>
<p>然后：</p>
<pre><code><span class="preprocessor"># rvm install 1.9.2</span></code></pre>
<p>出现错误，根据<code>/usr/local/rvm/1.9.2/extract.log</code>的错误提示，原来安装的过程中还需要用到<code>make</code>和<code>bzip2</code>这两个工具。</p>
<p>于是：</p>
<pre><code><span class="preprocessor"># aptitude install make bzip2</span></code></pre>
<p>接着：</p>
<figure class="highlight"><pre><span class="comment"># rvm install 1.9.2</span>
Fetching yaml-<span class="number">0.1</span><span class="number">.4</span>.tar.gz to /usr/local/rvm/archives
Extracting yaml-<span class="number">0.1</span><span class="number">.4</span>.tar.gz to /usr/local/rvm/src
Configuring yaml <span class="keyword">in</span> /usr/local/rvm/src/yaml-<span class="number">0.1</span><span class="number">.4</span>.
Compiling yaml <span class="keyword">in</span> /usr/local/rvm/src/yaml-<span class="number">0.1</span><span class="number">.4</span>.
Installing yaml to /usr/local/rvm/usr
Installing Ruby from <span class="keyword">source</span> to: /usr/local/rvm/rubies/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320, this may take a <span class="keyword">while</span> depend
ing on your cpu(s)<span class="keyword">...</span>

ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#fetching</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#extracting ruby-1.9.2-p320 to /usr/local/rvm/src/ruby-1.9.2-p320</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#extracted to /usr/local/rvm/src/ruby-1.9.2-p320</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#configuring</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#compiling</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#installing</span>
Retrieving rubygems-<span class="number">1.8</span><span class="number">.24</span>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span class="number">100</span>  371k  <span class="number">100</span>  371k    <span class="number">0</span>     <span class="number">0</span>  <span class="number">35412</span>      <span class="number">0</span>  <span class="number">0</span>:<span class="number">00</span>:<span class="number">10</span>  <span class="number">0</span>:<span class="number">00</span>:<span class="number">10</span> --:--:-- <span class="number">51058</span>
Extracting rubygems-<span class="number">1.8</span><span class="number">.24</span> <span class="keyword">...</span>
Removing old Rubygems files...
Installing rubygems-<span class="number">1.8</span><span class="number">.24</span> <span class="keyword">for</span> ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 <span class="keyword">...</span>
Installation of rubygems completed successfully.
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - adjusting <span class="comment">#shebangs for (gem irb erb ri rdoc testrb rake).</span>
ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#importing default gemsets (/usr/local/rvm/gemsets/)</span>
Install of ruby-<span class="number">1.9</span><span class="number">.2</span>-p320 - <span class="comment">#complete</span>
</pre></figure>

<p>然后通过git将octopress克隆到本地：</p>
<figure class="highlight"><pre><span class="comment"># git clone git://github.com/imathis/octopress.git octopress</span>
<span class="comment"># cd octopress</span>
====================================================================================
= NOTICE                                                                           =
====================================================================================
= RVM has encountered a new <span class="keyword">or</span> modified .rvmrc <span class="type">file</span> <span class="keyword">in</span> <span class="keyword">the</span> current directory       =
= This <span class="keyword">is</span> a shell <span class="keyword">script</span> <span class="keyword">and</span> therefore may <span class="keyword">contain</span> any shell commands.             =
=                                                                                  =
= Examine <span class="keyword">the</span> <span class="property">contents</span> <span class="keyword">of</span> this <span class="type">file</span> carefully <span class="keyword">to</span> be sure <span class="keyword">the</span> <span class="property">contents</span> are          =
= safe <span class="keyword">before</span> trusting <span class="keyword">it</span>! ( Choose v[iew] <span class="keyword">below</span> <span class="keyword">to</span> view <span class="keyword">the</span> <span class="property">contents</span> )            =
====================================================================================
Do you wish <span class="keyword">to</span> trust this .rvmrc <span class="type">file</span>? (/home/chenr/octopress/.rvmrc)
y[es], n[o], v[iew], c[ancel]&gt; y
Using /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320
</pre></figure>

<figure class="highlight"><pre><span class="comment"># rake install</span>
rake aborted!
You have already activated rake <span class="number">0.9</span><span class="number">.2</span><span class="number">.2</span>, <span class="keyword">but</span> your Gemfile requires rake <span class="number">0.9</span><span class="number">.2</span>. Using bundle exec may solve this.

(See full trace <span class="keyword">by</span> <span class="property">running</span> task <span class="keyword">with</span> <span class="comment">--trace)</span>
</pre></figure>

<p>也就是说要用bundle exec rake</p>
<figure class="highlight"><pre>root<span class="property">@deb600</span>-<span class="number">64</span>-mgmt:<span class="regexp">/home/chenr/</span>octopress<span class="comment"># bundle exec rake install</span>
<span class="comment">## Copying classic theme into ./source and ./sass</span>
root<span class="property">@deb600</span>-<span class="number">64</span>-mgmt:<span class="regexp">/home/chenr/</span>octopress<span class="comment">#</span>
</pre></figure>

<p>创建第一篇博客</p>
<figure class="highlight"><pre><span class="preprocessor"># bundle exec rake new_post["hello-octopress"]</span>
<span class="preprocessor"># vim ./source/_post/2012-04-30-hello-octopress.markdown</span>
</pre></figure>

<p>生成静态网站</p>
<figure class="highlight"><pre>deb600-<span class="number">64</span>-mgmt:/home/chenr/octopress/source/_posts<span class="comment"># bundle exec rake generat</span>
(<span class="keyword">in</span> /home/chenr/octopress)
<span class="comment">## Generating Site with Jekyll</span>
unchanged sass/screen.scss
Configuration <span class="keyword">from</span> /home/chenr/octopress/_config.yml
/usr/<span class="keyword">local</span>/rvm/rubies/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/lib/ruby/<span class="number">1.9</span><span class="number">.1</span>/net/https.rb:<span class="number">92</span>:<span class="keyword">in</span> `require': no such <span class="type">file</span> <span class="keyword">to</span> load <span class="comment">-- openssl (LoadError)</span>
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/rubies/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/lib/ruby/<span class="number">1.9</span><span class="number">.1</span>/net/https.rb:<span class="number">92</span>:<span class="keyword">in</span> `&lt;top (required)&gt;'
        <span class="keyword">from</span> /home/chenr/octopress/plugins/gist_tag.rb:<span class="number">10</span>:<span class="keyword">in</span> `require'
        <span class="keyword">from</span> /home/chenr/octopress/plugins/gist_tag.rb:<span class="number">10</span>:<span class="keyword">in</span> `&lt;top (required)&gt;'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/lib/jekyll/site.rb:<span class="number">76</span>:<span class="keyword">in</span> `require'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/lib/jekyll/site.rb:<span class="number">76</span>:<span class="keyword">in</span> `block <span class="keyword">in</span> setup'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/lib/jekyll/site.rb:<span class="number">75</span>:<span class="keyword">in</span> `each'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/lib/jekyll/site.rb:<span class="number">75</span>:<span class="keyword">in</span> `setup'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/lib/jekyll/site.rb:<span class="number">30</span>:<span class="keyword">in</span> `initialize'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/bin/jekyll:<span class="number">224</span>:<span class="keyword">in</span> `new'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/gems/jekyll-<span class="number">0.11</span><span class="number">.0</span>/bin/jekyll:<span class="number">224</span>:<span class="keyword">in</span> `&lt;top (required)&gt;'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/bin/jekyll:<span class="number">23</span>:<span class="keyword">in</span> `load'
        <span class="keyword">from</span> /usr/<span class="keyword">local</span>/rvm/gems/ruby-<span class="number">1.9</span><span class="number">.2</span>-p320/bin/jekyll:<span class="number">23</span>:<span class="keyword">in</span> `&lt;main&gt;'
</pre></figure>

<p>google<br><code>/usr/local/rvm/rubies/ruby-1.9.2-p320/lib/ruby/1.9.1/net/https.rb:92:in</code>require&#39;: no such file to load — openssl (LoadError)`</p>
<p>依稀记得octopress推荐使用ruby-1.9.2-p290，于是</p>
<figure class="highlight"><pre><span class="preprocessor"># rvm install ruby-1.9.2-p290</span>
<span class="preprocessor"># rvm use ruby-1.9.2-p290</span>
<span class="preprocessor"># bundle exec rake generate</span>
</pre></figure>

<p>错误依旧，傻眼了，还得求助google，我换了一下关键字<code>require&#39;: no such file to load -- openssl (LoadError)</code></p>
<p>这次有结果了：<a href="http://blog.bigdinosaur.org/setting-up-octopress/" target="_blank">Setting Up Octopress</a></p>
<p>原来是还缺<code>libssl-dev</code>这个软件包</p>
<pre><code><span class="preprocessor"># aptitude install libssl-dev</span>
<span class="preprocessor"># rvm reinstall ruby-1.9.2-p290</span></code></pre>
<p>终于成功了！归根结底，rvm在安装ruby时，即便缺乏依赖包也没有提示，看来用rvm来安装ruby不怎么靠谱啊。即便用rbenv</p>
<h1>nginx</h1>
<h2>编译和安装</h2>
<figure class="highlight"><pre><span class="comment">#</span> <span class="string">.</span><span class="comment">/configure</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">sbin</span>-<span class="comment">path=/usr/sbin</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">conf</span>-<span class="comment">path=/etc/nginx/nginx</span>.<span class="comment">conf</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">error</span>-<span class="comment">log</span>-<span class="comment">path=/var/log/nginx/error</span>.<span class="comment">log</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">pid</span>-<span class="comment">path=/var/run/nginx</span>.<span class="comment">pid</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">lock</span>-<span class="comment">path=/var/lock/nginx</span>.<span class="comment">lock</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span>-<span class="comment">log</span>-<span class="comment">path=/var/log/nginx/access</span>.<span class="comment">log</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span>-<span class="comment">client</span>-<span class="comment">body</span>-<span class="comment">temp</span>-<span class="comment">path=/var/lib/nginx/body</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span>-<span class="comment">proxy</span>-<span class="comment">temp</span>-<span class="comment">path=/var/lib/nginx/proxy</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span>-<span class="comment">fastcgi</span>-<span class="comment">temp</span>-<span class="comment">path=/var/lib/nginx/fastcgi</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span>-<span class="comment">debug</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span>-<span class="comment">http_stub_status_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span>-<span class="comment">http_flv_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span>-<span class="comment">http_ssl_module</span> <span class="comment">\</span>
 <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span>-<span class="comment">http_dav_module</span>


<span class="comment">Configuration</span> <span class="comment">summary</span>
  <span class="literal">+</span> <span class="comment">using</span> <span class="comment">system</span> <span class="comment">PCRE</span> <span class="comment">library</span>
  <span class="literal">+</span> <span class="comment">using</span> <span class="comment">system</span> <span class="comment">OpenSSL</span> <span class="comment">library</span>
  <span class="literal">+</span> <span class="comment">md5:</span> <span class="comment">using</span> <span class="comment">OpenSSL</span> <span class="comment">library</span>
  <span class="literal">+</span> <span class="comment">sha1:</span> <span class="comment">using</span> <span class="comment">OpenSSL</span> <span class="comment">library</span>
  <span class="literal">+</span> <span class="comment">using</span> <span class="comment">system</span> <span class="comment">zlib</span> <span class="comment">library</span>

  <span class="comment">nginx</span> <span class="comment">path</span> <span class="comment">prefix:</span> <span class="comment">"/usr/local/nginx"</span>
  <span class="comment">nginx</span> <span class="comment">binary</span> <span class="comment">file:</span> <span class="comment">"/usr/sbin"</span>
  <span class="comment">nginx</span> <span class="comment">configuration</span> <span class="comment">prefix:</span> <span class="comment">"/etc/nginx"</span>
  <span class="comment">nginx</span> <span class="comment">configuration</span> <span class="comment">file:</span> <span class="comment">"/etc/nginx/nginx</span>.<span class="comment">conf"</span>
  <span class="comment">nginx</span> <span class="comment">pid</span> <span class="comment">file:</span> <span class="comment">"/var/run/nginx</span>.<span class="comment">pid"</span>
  <span class="comment">nginx</span> <span class="comment">error</span> <span class="comment">log</span> <span class="comment">file:</span> <span class="comment">"/var/log/nginx/error</span>.<span class="comment">log"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">access</span> <span class="comment">log</span> <span class="comment">file:</span> <span class="comment">"/var/log/nginx/access</span>.<span class="comment">log"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">client</span> <span class="comment">request</span> <span class="comment">body</span> <span class="comment">temporary</span> <span class="comment">files:</span> <span class="comment">"/var/lib/nginx/body"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">proxy</span> <span class="comment">temporary</span> <span class="comment">files:</span> <span class="comment">"/var/lib/nginx/proxy"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">fastcgi</span> <span class="comment">temporary</span> <span class="comment">files:</span> <span class="comment">"/var/lib/nginx/fastcgi"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">uwsgi</span> <span class="comment">temporary</span> <span class="comment">files:</span> <span class="comment">"uwsgi_temp"</span>
  <span class="comment">nginx</span> <span class="comment">http</span> <span class="comment">scgi</span> <span class="comment">temporary</span> <span class="comment">files:</span> <span class="comment">"scgi_temp"</span>

<span class="comment">#</span> <span class="comment">make</span> <span class="comment">&</span> <span class="comment">make</span> <span class="comment">install
</pre></figure>

<h1>mkdir /var/log/nginx &amp;&amp; chown nginx:nignix /var/log/nginx</h1>
<h1>mkdir /var/lib/nginx &amp;&amp; chown nginx:nignix /var/lib/nginx</h1>
<figure class="highlight"><pre>/etc/<span class="filename">init.d/nginx
</pre></figure>

<p>检测一下：</p>
<pre><code><span class="preprocessor"># lynx localhost</span></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-02-11T15:30:00.000Z"><a href="/2012/02/11/how-to-install-debian-domU/">2012-02-11</a></time>
      
      
  
    <h1 class="title"><a href="/2012/02/11/how-to-install-debian-domU/">安装debian domU</a></h1>
  

    </header>
    <div class="entry">
      
        <p>在CentOS(dom0)安装debian/ubuntu有多种方式：</p>
<ol>
<li>debootstrap</li>
<li>virt-manager</li>
<li>cowboy</li>
</ol>
<p>在这里给大家演示后两种</p>
<p>dom0环境为：CentOS5.7，xen的版本是3.1.2，redhat在该版本中增加了对grub2的支持<br>{: class=“info” }</p>
<h2>一、virt-manager</h2>
<p>通过 virt-manager安装linux(hvm)很简单，就像在平常在物理机上安装linux一样，准备好iso镜像文件，再根据安装程序的提示，一步步操作就可以了。在安装的过程中，硬盘选择file backend，文件名为deb6-template，后面的步骤需要用到该镜像文件。</p>
<p>从官方网站下载的iso文件名为：debian-6.0.2.1-amd64-xfce+lxde-cd-1.iso，文件名太长了，在virt-manager中无法识别，因此需要修改文件名，譬如debian6-amd64.iso<br>{: class=“note” }</p>
<h2>二、cowboy</h2>
<p>cowboy这个词来自《the book of xen》，我估计是因为这种方式比较粗野，所以作者用了cowboy这个词。这种方式的思路是直接打包一台domU的系统文件，然后解压到另一台domU的硬盘中。虽说办法是糙了一点，但是非常适合于命令行下操作，可以实现大规模部署。</p>
<h3>2.1 创建模版</h3>
<p>上面我们已经使用virt-manager安装了一台debian 6.0.2的源domU，接下来通过这个源domU先创建模版</p>
<figure class="highlight"><pre><span class="comment">#</span> <span class="comment">mount</span> <span class="literal">-</span><span class="comment">o</span> <span class="comment">loop</span> <span class="comment">deb6</span>-<span class="comment">template</span>.<span class="comment">img</span> <span class="comment">/tmp/deb6</span>-<span class="comment">template</span>
<span class="comment">#</span> <span class="comment">chroot</span> <span class="comment">/tmp/deb6</span>-<span class="comment">template</span>
<span class="comment">#</span> <span class="comment">tar</span> <span class="literal">-</span><span class="comment">cvpzf</span> <span class="comment">deb6</span>.<span class="comment">0</span>.<span class="comment">2</span>-<span class="comment">template</span>.<span class="comment">tar</span>.<span class="comment">gz</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">exclude=/deb6</span>.<span class="comment">0</span>.<span class="comment">2</span>-<span class="comment">template</span>.<span class="comment">tar</span>.<span class="comment">gz</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">exclude=/tmp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">exclude=/lost</span>+<span class="comment">found</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">exclude=/media</span> <span class="comment">/</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">exclude=/mnt</span>  <span class="comment">/
</pre></figure>

<p>假如没有chroot的话，命令应该是：</p>
<pre><code><span class="comment">#</span> <span class="comment">tar</span> <span class="literal">-</span><span class="comment">cvpzf</span> <span class="comment">deb6</span>.<span class="comment">0</span>.<span class="comment">2</span>-<span class="comment">template</span>.<span class="comment">tar</span>.<span class="comment">gz</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">exclude=</span>.<span class="comment">/deb6</span>.<span class="comment">0</span>.<span class="comment">2</span>-<span class="comment">template</span>.<span class="comment">tar</span>.<span class="comment">gz</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">exclude=</span>.<span class="comment">/tmp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">exclude=</span>.<span class="comment">/lost</span>+<span class="comment">found</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">exclude=</span>.<span class="comment">/media</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">exclude=</span>.<span class="comment">/mnt</span>  <span class="comment">/</code></pre>
<p>网上很多文档都说在创建模版的时候要exclude掉<code>/sys</code>和<code>/proc</code>这两个目录，因为在系统运行的状态下，这两个目录含有一些临时文件，但是这些文档只说了一半，解压后到domU存储后，还要记得创建这两个目录，否则，系统运行会出错。另外，也可以将源domU关机，然后打包，因为关机后，domU中这两个目录是空的。<br>{: class=“note” }</p>
<h3>2.2 准备目标domU存储</h3>
<p>在这里，我们选择镜像文件作为参考，读者也可以选择lvm作为目标domU的存储。</p>
<figure class="highlight"><pre><span class="preprocessor"># dd if=/dev/zero of=/staff/domU/deb6-1.img bs=1000 count=2000K</span>
<span class="preprocessor"># parted /staff/domU/deb6-1.img mklabel msdos</span>
<span class="preprocessor"># parted /staff/domU/deb6-1.img mkpartfs primary ext2 0 1536</span>
<span class="preprocessor"># parted /staff/domU/deb6-1.img mkpart extend 1537 2048</span>
<span class="preprocessor"># parted /staff/domU/deb6-1.img mkpartfs logical linux-swap 1537 2048</span>
</pre></figure>

<p>以上命令是创建一个镜像文件，然后对其分区，先创建主分区，接着是扩展，然后是逻辑分区，swap分区位于逻辑分区。</p>
<figure class="highlight"><pre><span class="comment"># parted deb6-1.img</span>
&gt;<span class="keyword">set</span> <span class="number">1</span> boot <span class="function_start"><span class="keyword">on</span>
</span>&gt;quit
</pre></figure>

<p>这个步骤是为了将主分区置为boot，实际上这个步骤是多余的，即使primary不是boot flag也能启动。</p>
<h3>2.3 转换分区文件系统</h3>
<p>大家有没有注意到上面的步骤中，分区类型是ext2，这是因为CentOS5.7的parted版本为1.8.1，只支持ext2，最新的parted版本是3.03倒是支持ext3，然而没有for centos5.7的rpm，所以我们还需要将ext2手工转换成ext3。<br>{: class=“info” }</p>
<pre><code><span class="comment">#</span> <span class="comment">kpartx</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">""</span> <span class="literal">-</span><span class="comment">av</span> <span class="comment">/staff/domU/deb6</span>-<span class="comment">1</span>.<span class="comment">img</code></pre>
<p>将在/dev/mapper/下生成loopX1和loopX5两个device map，其中loopX1是primary分区，loopX5是swap分区</p>
<pre><code><span class="preprocessor"># tune2fs -j /dev/mapper/loopX1</span></code></pre>
<p>这样就将ext2转换成了ext3。</p>
<h3>2.4 克隆</h3>
<figure class="highlight"><pre><span class="preprocessor"># mount /dev/mapper/loopX1 /tmp/deb6-1</span>
<span class="preprocessor"># mount /dev/mapper/loopX1 /tmp/deb6-template</span>
<span class="preprocessor"># cp -rfp /tmp/deb6-template/* /tmp/deb6-1/</span>
</pre></figure>

<p>将文件拷贝到新的domU中之后，要记得卸载分区</p>
<figure class="highlight"><pre><span class="preprocessor"># umount /tmp/deb6-1</span>
<span class="preprocessor"># umount /tmp/deb6-template</span>
<span class="preprocessor"># kpartx -d /staff/domU/deb6-1.img</span>
<span class="preprocessor"># kpartx -d /staff/domU/deb6-template.img</span>
</pre></figure>

<h3>2.5 创建配置文件</h3>
<figure class="highlight"><pre><span class="comment">#</span> <span class="comment">vim</span> <span class="comment">/etc/xen/deb6</span>-<span class="comment">hvm</span>.<span class="comment">cfg</span>

<span class="comment">import</span> <span class="comment">os</span>, <span class="comment">re</span>
<span class="comment">arch</span> <span class="comment">=</span> <span class="comment">os</span>.<span class="comment">uname()</span>[<span class="comment">4</span>]
<span class="comment">if</span> <span class="comment">re</span>.<span class="comment">search('64'</span>, <span class="comment">arch):</span>
    <span class="comment">arch_libdir</span> <span class="comment">=</span> <span class="comment">'lib64'</span>
<span class="comment">else:</span>
    <span class="comment">arch_libdir</span> <span class="comment">=</span> <span class="comment">'lib'</span>

<span class="comment">kernel</span> <span class="comment">=</span> <span class="comment">"/usr/lib/xen/boot/hvmloader"</span>
<span class="comment">builder='hvm'</span>
<span class="comment">memory</span> <span class="comment">=</span> <span class="comment">1024</span>

<span class="comment">#</span> <span class="comment">Should</span> <span class="comment">be</span> <span class="comment">at</span> <span class="comment">least</span> <span class="comment">2KB</span> <span class="comment">per</span> <span class="comment">MB</span> <span class="comment">of</span> <span class="comment">domain</span> <span class="comment">memory</span>, <span class="comment">plus</span> <span class="comment">a</span> <span class="comment">few</span> <span class="comment">MB</span> <span class="comment">per</span> <span class="comment">vcpu</span>.
<span class="comment">shadow_memory</span> <span class="comment">=</span> <span class="comment">8</span>
<span class="comment">name</span> <span class="comment">=</span> <span class="comment">'deb6</span>-<span class="comment">hvm'</span>
<span class="comment">vif</span> <span class="comment">=</span> <span class="title">[</span> <span class="comment">'type=ioemu</span>, <span class="comment">bridge=eth0'</span> <span class="title">]</span>
<span class="comment">#acpi</span> <span class="comment">=</span> <span class="comment">1</span>
<span class="comment">#apic</span> <span class="comment">=</span> <span class="comment">1</span>
<span class="comment">disk</span> <span class="comment">=</span> <span class="title">[</span> <span class="comment">'file:/home/staff/vm</span>.<span class="comment">images/deb6</span>-<span class="comment">hvm</span>.<span class="comment">img</span>,<span class="comment">sda</span>,<span class="comment">w'</span>,
         <span class="comment">'file:/home/chenr/software/debian</span>-<span class="comment">6</span>.<span class="comment">0</span>.<span class="comment">2</span>.<span class="comment">1</span>-<span class="comment">amd64</span>.<span class="comment">iso</span>,<span class="comment">ioemu:hdc:cdrom</span>,<span class="comment">r'</span>
<span class="title">]</span>

<span class="comment">device_model</span> <span class="comment">=</span> <span class="comment">'/usr/'</span> <span class="literal">+</span> <span class="comment">arch_libdir</span> <span class="literal">+</span> <span class="comment">'/xen/bin/qemu</span>-<span class="comment">dm'</span>

<span class="comment">#</span>-<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">#</span> <span class="comment">boot</span> <span class="comment">on</span> <span class="comment">floppy</span> <span class="comment">(a)</span>, <span class="comment">hard</span> <span class="comment">disk</span> <span class="comment">(c)</span> <span class="comment">or</span> <span class="comment">CD</span>-<span class="comment">ROM</span> <span class="comment">(d)</span>
<span class="comment">#</span> <span class="comment">default:</span> <span class="comment">hard</span> <span class="comment">disk</span>, <span class="comment">cd</span>-<span class="comment">rom</span>, <span class="comment">floppy</span>
<span class="comment">boot="c"</span>
<span class="comment">sdl=0</span>
<span class="comment">vnc=1</span>
<span class="comment">vncconsole=3</span>
<span class="comment">vncpasswd=''</span>

<span class="comment">serial='pty'</span>
<span class="comment">usbdevice='tablet'</span>
<span class="comment">#on_reboot="destroy"</span>
<span class="comment">#on_poweroff="destroy"</span>
<span class="comment">#on_shutdown="destroy"</span>
<span class="comment">on_crash="preserve"
</pre></figure>

<p>需要注意的是，disk选项必须是：</p>
<pre><code><span class="setting">disk = <span class="value">[<span class="string">"file:/staff/domU/deb6-hvm.img,sda,w"</span>]</span></span></code></pre>
<p>不能是</p>
<pre><code><span class="setting">disk = <span class="value">[<span class="string">"tap:aio:/staff/domU/deb6-hvm.img,xvda,w"</span>]</span></span></code></pre>
<p>因为xen3.1.2不支持tap/xvda。</p>
<p>virt-manager是一种通用的安装方法，适合于安装全系列的linux/windows操作系统，不过不利于大规模部署，而cowboy的方式则适合于大规模、快速部署，跟virt-manager形成互补。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2010-04-16T15:00:00.000Z"><a href="/2010/04/16/ftp-service/">2010-04-16</a></time>
      
      
  
    <h1 class="title"><a href="/2010/04/16/ftp-service/">FTP服务</a></h1>
  

    </header>
    <div class="entry">
      
        <p>FTP全称是File Transfer Protocol（文件传输协议），顾名思义，它的作用是在网络中传送文件。这是Internet上一个比较古老的协议，早在1971年就已经诞生，那个年代的网络条件奇差，带宽小，掉线频繁，FTP应运而生，它的断点续传功能拯救了许许多多网民宝贵的时间，时至今日，它仍然在许多重要的应用环境中发挥着不可或缺的作用。</p>

      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2010/04/16/ftp-service/#more" class="more-link">Read More</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2010-03-20T01:15:00.000Z"><a href="/2010/03/20/ntp-service/">2010-03-20</a></time>
      
      
  
    <h1 class="title"><a href="/2010/03/20/ntp-service/">NTP服务</a></h1>
  

    </header>
    <div class="entry">
      
        <h1>一、什么是NTP，干什么用的？</h1>
<p>NTP的全称是network time protocol（网络时间协议），它的作用是用来同步电脑系统时间的。<br>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2010/03/20/ntp-service/#more" class="more-link">Read More</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2009-04-02T15:00:00.000Z"><a href="/2009/04/02/how-to-install-wireless-nic-on-debian/">2009-04-2</a></time>
      
      
  
    <h1 class="title"><a href="/2009/04/02/how-to-install-wireless-nic-on-debian/">如何在debian中安装无线网卡</a></h1>
  

    </header>
    <div class="entry">
      
        <p>记得2003年的时候，Wi-Fi设备用的是WEP加密协议，由于安全性问题而未能获得广泛应用。过去几年802.11获得长足的进步，WPA1/2，EAP-TLS等多种加密技术的实现大大促进了WiFi的传播，AP和无线网卡产品异常丰富，然而兼容Linux的还是屈指可数，能在Linux成功安装无线网卡的不仅仅靠技术和忍者神龟般的耐性，更多时候还要看人品！</p>
<p>在安装无线网卡之前有必要先了解一下WiFi的工作方式：</p>
<p><strong>AP</strong></p>
<p>AP是access point的简称，它将多个无线设备连接，无线设备通过它进行互联，也通过它联系外界，譬如互联网。</p>
<p><strong>WPA</strong></p>
<p>WPA全称是Wi-Fi Protected Access，是一种基于预协商key的加密方式，WPA之前802.11采用了WEP，后来证明是一种失败的加密方式，在安全性方面给Wi-Fi带来了很差的声誉，影响Wi-Fi的普及，WPA的出现扭转了乾坤。个人用户用得最多的是PSK，Pre shared key。<br>WPA的加密过程</p>
<p>安装无线网卡</p>
<p>在Linux中安装无线网卡驱动有两种方式，一种是通过ndiswrapper使用windows的驱动，另一种使用linux的原生驱动。</p>
<p>在第一种方式中，ndiswrapper是Linux内核中的一个模块，用于加载和运行windows内核的API和NDIS API驱动，换句话来说就是ndiswrapper将linux伪装成windows，使得无线网卡的 windows驱动可以跑在linux之上。Linux fans从心理上是抵触这种方式的，感觉要低windows users一等，其次在实际应用中也存在一些恼人的问题，因此是备选方案。</p>
<p>第二种方式是安装原生的linux的驱动，这种方式是最正宗的，直接由内核驱动硬件，效率也更高些，因此尽可能采用这种方式。可是目前linux针对无线网卡的驱动不多，因此在购买无线网卡之前需要确认一下是否兼容linux，下面是兼容linux的无线网卡列表：<a href="http://linux-wless.passys.nl/" target="_blank">http://linux-wless.passys.nl/</a></p>
<p>b43-phy0 debug: Adding Interface type 2<br>　　b43-phy0 ERROR: Firmware file “b43/ucode5.fw” not found or load failed.<br>　　b43-phy0 ERROR: You must go to <a href="http://linuxwireless.org/en/users/Drivers/bcm43xx#devicefirmware" target="_blank">http://linuxwireless.org/en/users/Drivers/bcm43xx#devicefirmware</a> and download the correct firmware (version 4).</p>
<ol>
<li>查看自己的无线网卡的芯片</li>
</ol>
<figure class="highlight"><pre>alfie:~<span class="comment"># lspci -vnn | less</span>
<span class="keyword">...</span>
<span class="number">02</span>:<span class="number">00.0</span> Network controller [<span class="number">0280</span>]: Broadcom Corporation BCM4306 <span class="number">802.</span>11b/g Wireless LAN Controller [<span class="number">14e4</span>:<span class="number">4320</span>] (rev <span class="number">03</span>)
        Subsystem: Linksys WPC54G [<span class="number">1737</span>:<span class="number">4320</span>]
        Flags: bus master, fast devsel, latency <span class="number">64</span>, IRQ <span class="number">11</span>
        Memory at <span class="number">24000000</span> (<span class="number">32</span>-bit, non-prefetchable) [size=8K]
        Capabilities: [<span class="number">40</span>] Power Management version <span class="number">2</span>
        Kernel driver <span class="keyword">in</span> use: b43-pci-bridge
        Kernel modules: ssb
<span class="keyword">...</span>
</pre></figure>

<p>可以看到Linux内核已经识别到了Linksys WPC54G了，它使用的芯片是Broadcom的BCM4320（我自己也说不清是4306还是4320，在<a href="http://lin...中说是以[14e4:4320]里面的数字为准）。" target="_blank">http://lin...中说是以[14e4:4320]里面的数字为准）。</a></p>
<p>针对Broadcom的芯片，linux社区专门提供了b43驱动，在2.6.17-rc2时，内核引入了bcm43xx这个驱动，从2.6.24开始引入了b43legacy和b43，并废掉bcm43xx，其中b43legacy负责Broadcom4306 ver2以前或者仅有802.11b功能的Broadcom芯片，而b43负责剩下的所有型号芯片。</p>
<p>上面的兼容列表比较含糊，Linksys WPC54G v1.2似乎被b43支持，又似乎被b43legacy支持，也顾不了那么多了，我决定先试一下b43。</p>
<p>识别了网卡之后还不能马上使用，因为Broadcom的芯片工作原理有些特殊，还需要给芯片加载专有的firmware才能正常工作，因为firmware是专有的，所以debian官方源里面不直接提供，需要用户自行下载。</p>
<ol>
<li><p>安装b43-fwcutter</p>
<p>aptitude install b43-fwcutter</p>
</li>
</ol>
<p>安装b43-fwcutter之后会提示是否自动去<a href="http://downloads.openwrt.org/sources下载相应的firmware并解压，此时应该选择否，因为openwrt.org的链接已经失效，需要手工下载。" target="_blank">http://downloads.openwrt.org/sources下载相应的firmware并解压，此时应该选择否，因为openwrt.org的链接已经失效，需要手工下载。</a></p>
<p>正确的地址应该是<a href="http://mirror2.openwrt.org/sources，我选择了最新的firmware：wl" target="_blank">http://mirror2.openwrt.org/sources，我选择了最新的firmware：wl</a>  4.160xxx</p>
<p>wget /home/software <a href="http://mirror2.openwrt.org/sources/xxx" target="_blank">http://mirror2.openwrt.org/sources/xxx</a><br>cd /home/software &amp;&amp; b43-fwcutter -w /lib/firmware xxx</p>
<p>/lib/firmware是b43内核模块默认去寻找Broadcom firmware的地方。</p>
<p>需要说明的是，</p>
<ol>
<li>安装wireless-tools</li>
</ol>
<p>这个软件包提供了几个针对无线网卡的程序，iwconfig，iwlist</p>
<p>4、安装wpasupplicant</p>
<p>debian lenny中对wpasupplicant的介绍<br>WPA and WPA2 are methods for securing wireless networks, the former using IEEE 802.1X, and the latter using IEEE 802.11i. This software provides key negotiation with the WPA Authenticator, and controls association with IEEE 802.11i networks.</p>
<p>在ubuntu中安装wpa-supplicant<br><a href="https://help.ubuntu.com/community/WifiDocs/Driver/bcm43xx/Feisty" target="_blank">https://help.ubuntu.com/community/WifiDocs/Driver/bcm43xx/Feisty</a></p>
<p>安装wpasupplicat和wpagui<br>aptitude install wpasupplicant wpagui<br>其中wpasupplicant中包含了wpa_cli</p>
<p>安装b43-fwcutter和wireless-tools<br>其中，boardcom公司为很多无线网卡厂商提供芯片，下面就是linksys wpc54G所使用的芯片<br>lspci -vnn<br>由于boardcom是一家商业公司，所以他提供的芯片驱动程序也具有商业性质，因此在debian的源中没有。我们需要通过openwrt.org这个源来下载，openwrt.org是说来话长，暂且按下不表。<br>b43-fwcutter安装完毕之后，将自动去downloads.openwrt.org/sources/wl_….下载firmware，然而这个链接已经失效，所以需要手工去下载。<br>wget <a href="http://mirror2.openwrt.org/sources/broadcom-wl-4.80.53.0.tar.bz2" target="_blank">http://mirror2.openwrt.org/sources/broadcom-wl-4.80.53.0.tar.bz2</a></p>
<p>然后通过b43-fwcutter -w /lib/firmware broadcom-wl-4.80.53.0.tar.bz2</p>
<p>接着modprobe b43</p>
<p>即可完成</p>
<p>这个时候通过iwlist wlan0 scan来测试驱动是否能够正常使用</p>
<figure class="highlight"><pre><span class="symbol">alfie:</span>/home/chenr<span class="comment"># iwlist wlan0 scan</span>
wlan<span class="number">0</span>     <span class="constant">Scan</span> completed <span class="symbol">:</span>
          <span class="constant">Cell</span> <span class="number">01</span> - <span class="constant">Address</span><span class="symbol">:</span> <span class="number">00</span><span class="symbol">:</span><span class="number">14</span><span class="symbol">:BF</span><span class="symbol">:F2</span><span class="symbol">:</span><span class="number">05</span><span class="symbol">:B7</span>
                    <span class="constant">ESSID</span><span class="symbol">:<span class="string">"dd-wrt"</span></span>
                    <span class="constant">Mode</span><span class="symbol">:Master</span>
                    <span class="constant">Channel</span><span class="symbol">:</span><span class="number">6</span>
                    <span class="constant">Frequency</span><span class="symbol">:</span><span class="number">2.437</span> <span class="constant">GHz</span> (<span class="constant">Channel</span> <span class="number">6</span>)
                    <span class="constant">Quality</span>=<span class="number">73</span>/<span class="number">100</span>  <span class="constant">Signal</span> level=-<span class="number">56</span> dBm  <span class="constant">Noise</span> level=-<span class="number">69</span> dBm
                    <span class="constant">Encryption</span> <span class="symbol">key:</span>on
                    <span class="constant">IE</span><span class="symbol">:</span> <span class="constant">WPA</span> <span class="constant">Version</span> <span class="number">1</span>
                        <span class="constant">Group</span> <span class="constant">Cipher</span> <span class="symbol">:</span> <span class="constant">TKIP</span>
                        <span class="constant">Pairwise</span> <span class="constant">Ciphers</span> (<span class="number">1</span>) <span class="symbol">:</span> <span class="constant">TKIP</span>
                        <span class="constant">Authentication</span> <span class="constant">Suites</span> (<span class="number">1</span>) <span class="symbol">:</span> <span class="constant">PSK</span>
                    <span class="constant">Bit</span> <span class="constant">Rates</span><span class="symbol">:</span><span class="number">1</span> <span class="constant">Mb</span>/s; <span class="number">2</span> <span class="constant">Mb</span>/s; <span class="number">5.5</span> <span class="constant">Mb</span>/s; <span class="number">11</span> <span class="constant">Mb</span>/s; <span class="number">18</span> <span class="constant">Mb</span>/s
                              <span class="number">24</span> <span class="constant">Mb</span>/s; <span class="number">36</span> <span class="constant">Mb</span>/s; <span class="number">54</span> <span class="constant">Mb</span>/s; <span class="number">6</span> <span class="constant">Mb</span>/s; <span class="number">9</span> <span class="constant">Mb</span>/s
                              <span class="number">12</span> <span class="constant">Mb</span>/s; <span class="number">48</span> <span class="constant">Mb</span>/s
                    <span class="constant">Extra</span><span class="symbol">:tsf=</span><span class="number">0000002</span>95b4c72c<span class="number">0</span>
</pre></figure>

<p>说明驱动已经可以正常使用了。</p>
<p>接下来需要配置wpa，这又是另外一个话题，先安装wpasupplicant</p>
<p><code>iwlist</code>和<code>iwconfig</code>是wireless-tools中的小程序，其中</p>
<p><code>iwlist</code>可以通过某长无限网卡扫描到ssid</p>
<p>iwlist wlan0 scanning</p>
<p>iwconfig类似ifconfig，主要为无限网卡提供设置服务。</p>
<p>配置/etc/network/interface</p>
<p>~~~<br>allow-hotplug wlan0<br>iface wlan0 inet manual<br>        wpa-ssid dd-wrt<br>        wpa-psk hainanyidong</p>
<p>由于psk的密码明文显示在interface这个文件中，所以需要限制仅root可以对改文件进行修改</p>
<p>chmod 0600 /etc/network/interface</p>
<p>最后启动wlan0,invoke-rc.d networking restart<br>这句的好处是不需要重启机器。如果使用ifdown wlan0和ifup wlan0会显示尚未定义。</p>
<p>下面两行是用于??</p>
<pre><code>    wpa-driver wext
    wpa-roam /etc/wpa_supplicant/<span class="filename">wpa_supplicant.conf</code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2008-08-04T04:45:00.000Z"><a href="/2008/08/04/how-to-change-nic-id-on-debian/">2008-08-4</a></time>
      
      
  
    <h1 class="title"><a href="/2008/08/04/how-to-change-nic-id-on-debian/">如何在debian etch中修改网卡ID</a></h1>
  

    </header>
    <div class="entry">
      
        <p>在使用VMware的时候，往往需要创建多个虚拟机，为此，VMware提供了一个便利的功能：clone（克隆）。用户只需要装好一台虚拟机，然后使用clone功能就可以复制出多个虚拟机了，省时省事。</p>
<p>然而VMware为了避免目标和源这两台虚拟机之间的网卡冲突，在复制的过程中，自动修改了目标虚拟机网卡的MAC地址。于是当目标虚拟机启动的时候，系统就会赋予这些网卡新的id，譬如源虚拟机装了3张网卡，那么目标虚拟机的网卡id就是eth3、eth4和eth5，这是因为udev这个服务进程检测到有新的网卡（新的mac地址），于是重新加载驱动，赋予该网卡新的id（因为旧网卡id尚未删除）。假如在目标虚拟机上再重新clone，网卡id还会继续增长，这样的网卡id看起来很碍眼，解决办法是修改<code>/etc/udev/rules.d/zNN_persistent-net.rules</code>文件。</p>
<ul>
<li>修改前的<code>zNN_persistent-net.rules</code></li>
</ul>
<figure class="highlight"><pre><span class="preprocessor"># This file was automatically generated by the /lib/udev/write_net_rules</span>
<span class="preprocessor"># program, probably run by the persistent-net-generator.rules rules file.</span>
<span class="preprocessor">#</span>
<span class="preprocessor"># You can modify it, as long as you keep each rule on a single line.</span>
<span class="preprocessor"># MAC addresses must be written in lowercase.</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
SUBSYSTEM==<span class="string">"net"</span>, DRIVERS==<span class="string">"?*"</span>, ATTRS{address}==<span class="string">"00:0c:29:a8:e8:91"</span>, NAME=<span class="string">"eth0"</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
SUBSYSTEM==<span class="string">"net"</span>, DRIVERS==<span class="string">"?*"</span>, ATTRS{address}==<span class="string">"00:0c:29:a8:e8:9b"</span>, NAME=<span class="string">"eth1"</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
SUBSYSTEM==<span class="string">"net"</span>, DRIVERS==<span class="string">"?*"</span>, ATTRS{address}==<span class="string">"00:0c:29:a8:e8:a5"</span>, NAME=<span class="string">"eth2"</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
SUBSYSTEM==<span class="string">"net"</span>, DRIVERS==<span class="string">"?*"</span>, ATTRS{address}==<span class="string">"00:0c:29:2e:e1:61"</span>, NAME=<span class="string">"eth4"</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
SUBSYSTEM==<span class="string">"net"</span>, DRIVERS==<span class="string">"?*"</span>, ATTRS{address}==<span class="string">"00:0c:29:2e:e1:6b"</span>, NAME=<span class="string">"eth3"</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
SUBSYSTEM==<span class="string">"net"</span>, DRIVERS==<span class="string">"?*"</span>, ATTRS{address}==<span class="string">"00:0c:29:2e:e1:57"</span>, NAME=<span class="string">"eth5"</span>
</pre></figure>

<p>配置文件中有6张网卡，实际在用的只有三张，其mac地址末尾分别是61，6b和57，eth0、eth1和eth2已经失效，我们只需将e旧的th0、eth1、eth2注释掉，然后再将这几个网卡id赋予新的网卡即可。</p>
<ul>
<li>修改后的<code>zNN_persistent-net.rules</code></li>
</ul>
<figure class="highlight"><pre><span class="preprocessor"># This file was automatically generated by the /lib/udev/write_net_rules</span>
<span class="preprocessor"># program, probably run by the persistent-net-generator.rules rules file.</span>
<span class="preprocessor">#</span>
<span class="preprocessor"># You can modify it, as long as you keep each rule on a single line.</span>
<span class="preprocessor"># MAC addresses must be written in lowercase.</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
<span class="preprocessor"># SUBSYSTEM=="net", DRIVERS=="?*", ATTRS{address}=="00:0c:29:a8:e8:91", NAME="eth0"</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
<span class="preprocessor"># SUBSYSTEM=="net", DRIVERS=="?*", ATTRS{address}=="00:0c:29:a8:e8:9b", NAME="eth1"</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
<span class="preprocessor"># SUBSYSTEM=="net", DRIVERS=="?*", ATTRS{address}=="00:0c:29:a8:e8:a5", NAME="eth2"</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
SUBSYSTEM==<span class="string">"net"</span>, DRIVERS==<span class="string">"?*"</span>, ATTRS{address}==<span class="string">"00:0c:29:2e:e1:61"</span>, NAME=<span class="string">"eth1"</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
SUBSYSTEM==<span class="string">"net"</span>, DRIVERS==<span class="string">"?*"</span>, ATTRS{address}==<span class="string">"00:0c:29:2e:e1:6b"</span>, NAME=<span class="string">"eth2"</span>

<span class="preprocessor"># PCI device 0x1022:0x2000 (pcnet32)</span>
SUBSYSTEM==<span class="string">"net"</span>, DRIVERS==<span class="string">"?*"</span>, ATTRS{address}==<span class="string">"00:0c:29:2e:e1:57"</span>, NAME=<span class="string">"eth0"</span>
</pre></figure>

<p>重启虚拟机后，网卡id就变会<code>eth0/eth1/eth2</code>了。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2007-07-18T04:45:00.000Z"><a href="/2007/07/18/how-to-install-lvm-on-debian/">2007-07-18</a></time>
      
      
  
    <h1 class="title"><a href="/2007/07/18/how-to-install-lvm-on-debian/">如何在debian中安装和使用lvm2</a></h1>
  

    </header>
    <div class="entry">
      
        <p>本文在VMware的虚拟机中测试通过，为了做这个实验，需要新增加一块硬盘，接着就可以利用该硬盘来安装和使用lvm。</p>
<h2>一、准备物理硬盘和分区</h2>
<ol>
<li><code># cfdisk /dev/sdb</code></li>
<li>将该硬盘做成extended分区，并write分区表</li>
<li>使用fdisk -l就可以看到该硬盘了。</li>
</ol>
<h2>二、安装并配置lvm</h2>
<p>1、安装lvm2</p>
<pre><code><span class="preprocessor"># aptitude install lvm2</span></code></pre>
<p>2、初始化物理卷</p>
<pre><code># pv<span class="operator"><span class="keyword">create</span> /dev/sdb5</code></pre>
<p>3、创建卷组</p>
<pre><code># vg<span class="operator"><span class="keyword">create</span> volgrp /dev/sdb5</code></pre>
<p>4、激活卷组</p>
<pre><code><span class="preprocessor"># vgscan</span></code></pre>
<p>5、创建逻辑卷</p>
<pre><code><span class="comment">#</span> <span class="comment">lvcreate</span> <span class="literal">-</span><span class="comment">n</span> <span class="comment">software</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">size</span> <span class="comment">500M</span> <span class="comment">volgrp</code></pre>
<p>6、格式化并mount该逻辑卷</p>
<pre><code><span class="preprocessor"># mkfs.ext3 /dev/volgrp/software</span>
<span class="preprocessor"># mkdir /home/software</span>
<span class="preprocessor"># mount -t ext3 /dev/volgrp/software /home/software</span></code></pre>
<p>7、查看逻辑卷</p>
<pre><code><span class="preprocessor"># lvdisplay</span></code></pre>
<p>8、改变逻辑卷的大小</p>
<pre><code><span class="preprocessor"># umount /home/software</span>
<span class="preprocessor"># lvextended -L+500M /dev/volgrp/software</span></code></pre>
<p>改变之后，在lvdisplay可以看到大小已经改变，但是实际的文件系统还是500M，所以还需要做以下的操作</p>
<p>9、改变物理卷大小</p>
<pre><code><span class="preprocessor"># e2fsck -f /dev/volgrp/software</span>
<span class="preprocessor"># resize2fs /dev/volgrp/software</span></code></pre>
<p>10、重新mount该逻辑卷</p>
<pre><code><span class="preprocessor"># mount -t ext3 /dev/volgrp/software /home/software</span>
<span class="preprocessor"># df -h</span></code></pre>
<p>使用df -h就可以看到该分区的大小了。</p>
<p>11、去除逻辑卷</p>
<pre><code><span class="preprocessor"># lvremove /dev/volgrp/software</span></code></pre>
<p>前提：先umount该逻辑卷</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2007-05-09T15:00:00.000Z"><a href="/2007/05/09/how-to-upgrade-from-sarge-to-etch/">2007-05-9</a></time>
      
      
  
    <h1 class="title"><a href="/2007/05/09/how-to-upgrade-from-sarge-to-etch/">如何从sarge升级到etch</a></h1>
  

    </header>
    <div class="entry">
      
        <p>这两天做sarge到etch的升级，参考了官方的release note，<br>结合自己的实践写下本文，以便日后查询之用。</p>
<p>Debian官方建议使用aptitude来管理包，所以下面的操作均<br>以aptitude为例，需要说明的是一旦用了aptitude，就不要<br>再混用apt-get。</p>
<p>本文假定用户没有安装X windows系统，毕竟Debian更适合于<br>做服务器，桌面还是用Ubuntu吧。</p>
<h1>1. 备份</h1>
<p>将系统中重要的系统文件做备份，一般是配置文件、数据库等</p>
<pre><code><span class="preprocessor"># tar -cvf /home/backup/etc.bak /etc/*</span></code></pre>
<h1>2. 准备升级环境</h1>
<p>升级的过程中会重启一些服务，所以千万不要通过telnet、<br>ssh远程连接方式进行升级，最好在本机的终端窗口下操作<br>（不要在X windows），或者通过modem的serial口远程登录。<br>（这跟telnet、ssh的远程连接有所区别，cisco等网络设备<br>经常会用到这种方式）</p>
<h1>3. 检查系统软件包状态</h1>
<p>系统中如果有软件包处于hold状态，则在升级过程中可能<br>失败，最好手工将他们设为unhold</p>
<figure class="highlight lang-bash"><pre><span class="comment"># aptitude search "~ahold" | grep "^.h"</span>
<span class="comment"># aptitude unhold pkg_name</span>
</pre></figure>

<p>如果sarge系统中使用了非官方的软件包，例如backports，<br>最好先将他们全部卸载，否则升级过程中会引起冲突。<br>{: class=“warning” }</p>
<h1>4. 更改source.list</h1>
<figure class="highlight"><pre><span class="comment">#</span> <span class="comment">vi</span> <span class="comment">/etc/apt/source</span>.<span class="comment">list</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">8</span>&lt;<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">#</span> <span class="comment">deb</span> <span class="comment">http://debian</span>.<span class="comment">cn99</span>.<span class="comment">com/debian</span> <span class="comment">sarge</span> <span class="comment">main</span> <span class="comment">contrib</span> <span class="comment">non</span>-<span class="comment">free</span>
<span class="comment">deb</span> <span class="comment">http://debian</span>.<span class="comment">cn99</span>.<span class="comment">com/debian</span> <span class="comment">etch</span> <span class="comment">main</span> <span class="comment">contrib</span> <span class="comment">non</span>-<span class="comment">free</span>
<span class="comment">#</span> <span class="comment">deb</span>-<span class="comment">src</span> <span class="comment">http://debian</span>.<span class="comment">cn99</span>.<span class="comment">com/debian</span> <span class="comment">sarge</span> <span class="comment">main</span> <span class="comment">contrib</span> <span class="comment">non</span>-<span class="comment">free</span>
<span class="comment">deb</span>-<span class="comment">src</span> <span class="comment">http://debian</span>.<span class="comment">cn99</span>.<span class="comment">com/debian</span> <span class="comment">etch</span> <span class="comment">main</span> <span class="comment">contrib</span> <span class="comment">non</span>-<span class="comment">free</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">8</span>&lt;<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
</pre></figure>

<p>中国一般用cn99源，速度比较快，只需要将sarge改为etch就可以了。</p>
<h1>5. 更新软件包列表</h1>
<pre><code># aptitude <span class="operator"><span class="keyword">update</span></code></pre>
<h1>6. 确认具有足够的硬盘空间</h1>
<p>在升级的过程中需要占用一些临时的磁盘空间，所以要确认是否还有足够的剩余空间</p>
<figure class="highlight"><pre><span class="comment"># aptitude -y -s -f --with-recommends dist-upgrade</span>
     [ <span class="keyword">...</span> ]
     XXX upgraded, XXX newly installed, XXX to remove and XXX not upgraded.
     Need to get xx.xMB/yyyMB of archives. After unpacking AAAMB will be used.
     Would download/install/remove packages.
</pre></figure>

<p>如果不能满足请删除一些文件，例如aptitude clean或者删除/var/log</p>
<h1>7. 升级</h1>
<p>sarge和etch之间有不少软件包是有冲突的，直接使用<br><code>aptitude dist-upgrade</code>会卸载掉sarge系统里的软件包，而有些软件包是<br>你想保留的，为了尽量避免这种情况发生，需要做阶段性升级，分三个步骤：</p>
<h2>7.1 最小化升级：</h2>
<pre><code><span class="preprocessor"># aptitude upgrade</span>

这样就只是更新的软件而不会删除其他东西。

<span class="preprocessor"># aptitude install initrd-tools</span>

这将会自动升级libc6和locale，这个时候会重启某些服务。</code></pre>
<h2>7.2 升级内核</h2>
<p>在做下一步操作之前强烈建议手工升级内核，Etch引进的udev技术已经无法支持比2.6.15旧的内核，而Debian Etch的软件仓库中的内核版本则是2.6.18。我们安装它就可以了。</p>
<p>先确认一下你目前的内核版本</p>
<pre><code><span class="preprocessor"># uname -r</span></code></pre>
<figure class="highlight lang-bash"><pre><span class="comment"># aptitude search linux-image-2.6*</span>
<span class="comment"># aptitude install linux-image-2.6-686</span>
</pre></figure>

<p>这样就可以安装2.6.18的内核了。</p>
<h2>7.3 全面升级</h2>
<pre><code><span class="preprocessor"># aptitude dist-upgrade</span></code></pre>
<p>这将会对sarge进行完全的更新，时间大约半个小时，比我预料中要快很多。</p>
<h1>8. 更新软件包的签名信息</h1>
<p>Etch的软件包关系系统引入了签名功能，简言之，没有经过Debian官方<br>签署的软件包无法在etch系统上安装，你当然也可以通过更改<br><code>/etc/apt/</code>来取消这个限制。</p>
<pre><code># aptitude <span class="operator"><span class="keyword">update</span></code></pre>
<p>至此，您的操作系统就更新完毕了，整个过程不需要重启，这对服务器而言无疑是非常贴心的一项设计。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  

  <nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:ioiioi.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/RouterOS/MikroTik/">MikroTik</a><small>2</small></li>
  
    <li><a href="/categories/RouterOS/">RouterOS</a><small>3</small></li>
  
    <li><a href="/categories/VPS/">VPS</a><small>1</small></li>
  
    <li><a href="/categories/confluence/">confluence</a><small>1</small></li>
  
    <li><a href="/categories/dhcp/debian/">debian</a><small>1</small></li>
  
    <li><a href="/categories/ldap/debian/">debian</a><small>1</small></li>
  
    <li><a href="/categories/debian/">debian</a><small>12</small></li>
  
    <li><a href="/categories/dhcp/">dhcp</a><small>1</small></li>
  
    <li><a href="/categories/ubuntu/domU/">domU</a><small>1</small></li>
  
    <li><a href="/categories/debian/domU/">domU</a><small>1</small></li>
  
    <li><a href="/categories/freebsd/">freebsd</a><small>1</small></li>
  
    <li><a href="/categories/iptable/">iptable</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/iscsi/">iscsi</a><small>1</small></li>
  
    <li><a href="/categories/xen/kvm/">kvm</a><small>1</small></li>
  
    <li><a href="/categories/kvm/">kvm</a><small>1</small></li>
  
    <li><a href="/categories/ldap/">ldap</a><small>1</small></li>
  
    <li><a href="/categories/network/ldap/">ldap</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/linksys/">linksys</a><small>1</small></li>
  
    <li><a href="/categories/linux/">linux</a><small>1</small></li>
  
    <li><a href="/categories/linux/netbsd/">netbsd</a><small>1</small></li>
  
    <li><a href="/categories/openbsd/netmgmt/">netmgmt</a><small>1</small></li>
  
    <li><a href="/categories/network/">network</a><small>3</small></li>
  
    <li><a href="/categories/debian/network/">network</a><small>2</small></li>
  
    <li><a href="/categories/networking/">networking</a><small>1</small></li>
  
    <li><a href="/categories/nexenta/">nexenta</a><small>4</small></li>
  
    <li><a href="/categories/octopress/">octopress</a><small>3</small></li>
  
    <li><a href="/categories/debian/octopress/">octopress</a><small>2</small></li>
  
    <li><a href="/categories/openSUSE/">openSUSE</a><small>2</small></li>
  
    <li><a href="/categories/openbsd/">openbsd</a><small>8</small></li>
  
    <li><a href="/categories/openbsd openntpd/">openbsd openntpd</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/">openwrt</a><small>1</small></li>
  
    <li><a href="/categories/others/">others</a><small>1</small></li>
  
    <li><a href="/categories/linux/netbsd/solaris/">solaris</a><small>1</small></li>
  
    <li><a href="/categories/ubuntu/">ubuntu</a><small>1</small></li>
  
    <li><a href="/categories/vim/">vim</a><small>1</small></li>
  
    <li><a href="/categories/debian/virtualbox/">virtualbox</a><small>1</small></li>
  
    <li><a href="/categories/virtualbox/">virtualbox</a><small>5</small></li>
  
    <li><a href="/categories/windows/virtualbox/">virtualbox</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/">virtualization</a><small>2</small></li>
  
    <li><a href="/categories/kvm/virtualization/">virtualization</a><small>1</small></li>
  
    <li><a href="/categories/vpn/">vpn</a><small>1</small></li>
  
    <li><a href="/categories/windows/">windows</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/debian/domU/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/xen/">xen</a><small>2</small></li>
  
    <li><a href="/categories/ubuntu/domU/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/xen/kvm/虚拟化/">虚拟化</a><small>1</small></li>
  
  </ul>
</div>


  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 alfie chan
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>